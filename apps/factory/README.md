# Intelligence Product Factory (Next.js App)

This app (`apps/factory/`) is the new **Intelligence Product Factory** SaaS UI + backend (Next.js App Router).

It is developed as part of **Autonomous Modular Delivery (AMD)**. See:
- `docs/amd/README.md` (module roadmap + flags)

## Feature flag
The app is deployed but gated behind:
- `FEATURE_FACTORY_APP=true`

When disabled, the home page shows a “disabled” screen.

## AMD flags (M1–M6)
The Factory app uses module flags (see `docs/amd/README.md`):
- `FEATURE_RBAC=true` (M1)
- `FEATURE_EVIDENCE_INGEST=true` (M2)
- `FEATURE_ENTITY_LINKING=true` (M3)
- `FEATURE_SIGNALS=true` (M4)
- `FEATURE_PRODUCT_FACTORY=true` (M5)
- `FEATURE_REVIEW_DISTRIBUTION=true` (M6)

## Local development (recommended)

### 1) Start infra
From repo root:

```bash
docker compose up -d
```

This starts:
- Postgres (`localhost:5432`)
- Redis (`localhost:6379`)

### 2) Run control-plane migrations
VirtuaSOC’s Fastify API currently owns SQL migrations for the control-plane tables (tenants + NextAuth + RBAC).

Run once (from repo root):

```bash
npm -w @virtuasoc/api run db:migrate:control
```

### 3) Configure env
Create a `.env` in repo root or set env vars for the factory process. Minimum required for Entra sign-in:
- `FEATURE_FACTORY_APP=true`
- `CONTROL_DATABASE_URL=postgres://postgres:postgres@localhost:5432/virtuasoc_control`
- `TENANT_DSN_ENCRYPTION_KEY=...` (32 bytes base64/hex)
- `NEXTAUTH_URL=http://localhost:3000`
- `NEXTAUTH_SECRET=...`
- `ENTRA_CLIENT_ID=...`
- `ENTRA_CLIENT_SECRET=...`
- `ENTRA_TENANT_ID=...`

See `config/env.example` for the full set.

### 4) Run the factory app

```bash
npm -w @virtuasoc/factory run dev
```

Open `http://localhost:3000`.

## Product Factory (M5/M6)
### LLM provider
Product drafts are generated by the worker job `products.generate`.
- Dev default: `LLM_PROVIDER=mock`
- Production: `LLM_PROVIDER=openai` plus `OPENAI_API_KEY` and `OPENAI_MODEL=gpt-5.2`

### Review + distribution (PDF)
- Review/distribution features are gated by `FEATURE_REVIEW_DISTRIBUTION=true`.
- PDF generation is done in the worker (`products.distribute` with `renderOnly=true`), and PDFs are stored in the tenant DB (`product_exports`).
- Email/webhook/Teams distribution uses tenant-scoped `distribution_targets` (configure via the setup assistant or direct DB/API).

## Prisma notes
This app uses **two Prisma schemas**:
- `prisma/control/schema.prisma` (control-plane)
- `prisma/tenant/schema.prisma` (tenant-plane)

Generated clients are output under `apps/factory/src/generated/*` via:

```bash
npm -w @virtuasoc/factory run prisma:generate
```

In containers, Prisma clients are generated during build and copied into the runtime image.

