generator client {
  provider = "prisma-client-js"
  output   = "../../src/generated/tenant"
}

datasource db {
  provider = "postgresql"
  url      = env("TENANT_DATABASE_URL")
}

/// Tenant-plane evidence. Even with DB-per-tenant, we keep tenantId for defense-in-depth.
model EvidenceItem {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  fetchedAt DateTime @db.Timestamptz @map("fetched_at")

  sourceType String  @map("source_type")
  sourceUri  String? @map("source_uri")

  contentHash String? @map("content_hash")
  title       String?
  summary     String?
  contentText String? @map("content_text")
  handling    String?

  tags         String[] @default([])
  metadata     Json     @default("{}")
  triageStatus String   @default("new") @map("triage_status")

  entityLinks EvidenceEntityLink[]

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, fetchedAt(sort: Desc)])
  @@index([tenantId, sourceUri])
  @@index([tenantId, contentHash])
  @@map("evidence_items")
}

model Entity {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  type        String
  name        String
  description String?
  piiFlag     Boolean @default(false) @map("pii_flag")
  metadata    Json    @default("{}")

  links EvidenceEntityLink[]

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, type])
  @@map("entities")
}

model EvidenceEntityLink {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  evidenceId String  @db.Uuid @map("evidence_id")
  entityId   String  @db.Uuid @map("entity_id")
  notes      String?

  evidence EvidenceItem @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  entity   Entity       @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([tenantId, evidenceId, entityId])
  @@index([tenantId, entityId, createdAt(sort: Desc)])
  @@index([tenantId, evidenceId, createdAt(sort: Desc)])
  @@map("evidence_entity_links")
}

model RssFeed {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  url       String
  title     String?
  enabled   Boolean  @default(true)

  @@unique([tenantId, url])
  @@index([tenantId, createdAt(sort: Desc)])
  @@map("rss_feeds")
}

model IngestPrefs {
  tenantId            String   @id @db.Uuid @map("tenant_id")
  createdAt           DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt           DateTime @updatedAt @db.Timestamptz @map("updated_at")
  rssDefaultTags      String[] @default([]) @map("rss_default_tags")
  rssAutoTriageStatus String   @default("new") @map("rss_auto_triage_status")

  @@map("ingest_prefs")
}

model DistributionTarget {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid @map("tenant_id")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  kind    String
  label   String?
  value   String
  enabled Boolean @default(true)

  @@index([tenantId, createdAt(sort: Desc)])
  @@map("distribution_targets")
}


